/* Not included
FAM407-FP-A
FAM412-FP-A
FAM422-FP-A
FAM434-FP-A
FAM435-FP-A
FAM442-FP-A
FAM443-FP-A
FAM448-FP-A
FAM468-FP-A
FAM473-FP-A
FAM478-FP-A
FAM489-FP-A

*/

var listOfSites = {
  "cities": [
    {
      "cname": "N. Falmouth",
      "lat": "41.640818",
      "lng": "-70.612308",
      "preceptor": "Natalie Chambers, M.D.",
      "scode": "FAM392-FP-A"
    },
    {
      "cname": "Northampton",
      "lat": "42.312550",
      "lng": "-72.625208",
      "preceptor": "Stephanie Silverman, M.D. and Adam Garretson, M.D.",
      "scode": "FAM396-FP-A"
    },
    {
      "cname": "Cambridge",
      "lat": "42.364689",
      "lng": "-71.096797",
      "preceptor": "Katherine Miller, M.D.",
      "scode": "FAM398-FP-A"
    },
    {
      "cname": "Gloucester",
      "lat": "42.626437",
      "lng": "-70.680573",
      "preceptor": "Kathryn Hollett, M.D.",
      "scode": "FAM399-FP-A"
    },
    {
      "cname": "Arlington",
      "lat": "42.416625",
      "lng": "-71.154179",
      "preceptor": "Wayne Altman, M.D.",
      "scode": "FAM401-FP-A"
    },
    {
      "cname": "Lynn",
      "lat": "42.466763",
      "lng": "-70.949494",
      "preceptor": "David Douglas, M.D.",
      "scode": "FAM406-FP-A"
    },
    {
      "cname": "Georgetown",
      "lat": "42.721206",
      "lng": "-70.993078",
      "preceptor": "Scott Berzansky, M.D.",
      "scode": "FAM408-FP-A"
    },
    {
      "cname": "Tewksbury",
      "lat": "42.577791",
      "lng": "-71.194357",
      "preceptor": "Andrew Escoll, M.D. and Steven Guay, M.D.",
      "scode": "FAM409-FP-A"
    },
    {
      "cname": "Derry",
      "lat": "42.897441",
      "lng": "-71.324098",
      "preceptor": "John Daley, M.D.",
      "scode": "FAM410-FP-A"
    },
    {
      "cname": "West Peabody",
      "lat": "42.550353",
      "lng": "-71.009255",
      "preceptor": "Alain Chaoui, M.D.",
      "scode": "FAM413-FP-A"
    },
    {
      "cname": "Holyoke",
      "lat": "42.166764",
      "lng": "-72.633664",
      "preceptor": "Stephen Levine, M.D.",
      "scode": "FAM414-FP-A"
    },
    {
      "cname": "Wellesley",
      "lat": "42.316610",
      "lng": "-71.244285",
      "preceptor": "Sarah Rosenberg-Scott, M.D.",
      "scode": "FAM416-FP-A"
    },
    {
      "cname": "S. Hamilton",
      "lat": "42.612417",
      "lng": "-70.875034",
      "preceptor": "Andrew Lenhardt, M.D.",
      "scode": "FAM417-FP-A"
    },
    {
      "cname": "Somerville",
      "lat": "42.399740",
      "lng": "-71.111859",
      "preceptor": "Parra Tomkins, M.D.",
      "scode": "FAM418-FP-A"
    },
    {
      "cname": "Shrewsbury",
      "lat": "42.293050",
      "lng": "-71.704429",
      "preceptor": "Joe Daigneault, M.D.",
      "scode": "FAM419-FP-A"
    },
    {
      "cname": "Foxboro",
      "lat": "42.051412",
      "lng": "-71.239396",
      "preceptor": "Richard Popovic, M.D.",
      "scode": "FAM420-FP-A"
    },
    {
      "cname": "Medfield",
      "lat": "42.187952",
      "lng": "-71.307209",
      "preceptor": "Laura Garelick, M.D.",
      "scode": "FAM421-FP-A"
    },
    {
      "cname": "Lakeville",
      "lat": "41.846241",
      "lng": "-70.952981",
      "preceptor": "Robert Gagnon, M.D.",
      "scode": "FAM423-FP-A"
    },
    {
      "cname": "Winchester",
      "lat": "42.453826",
      "lng": "-71.136571",
      "preceptor": "Heather Jones, M.D.",
      "scode": "FAM424-FP-A"
    },
    {
      "cname": "Stockbridge",
      "lat": "42.287587",
      "lng": "-73.320386",
      "preceptor": "Joseph Cooney, M.D.",
      "scode": "FAM426-FP-A"
    },
    {
      "cname": "Lee",
      "lat": "42.291137",
      "lng": "-73.281795",
      "preceptor": "Mark Snowise, M.D.",
      "scode": "FAM430-FP-A"
    },
    {
      "cname": "Brockton",
      "lat": "42.073890",
      "lng": "-71.046487",
      "preceptor": "Douglas Grogan, M.D.",
      "scode": "FAM431-FP-A"
    },
    {
      "cname": "Marblehead",
      "lat": "42.493726",
      "lng": "-70.871943",
      "preceptor": "Jeffrey Gold, M.D.",
      "scode": "FAM432-FP-A"
    },
    {
      "cname": "Lee",
      "lat": "42.282597",
      "lng": "-73.254237",
      "preceptor": "Michael Kaplan, M.D.",
      "scode": "FAM437-FP-A"
    },
    {
      "cname": "Lawrence",
      "lat": "42.708763",
      "lng": "-71.163691",
      "preceptor": "Joel Gorn, M.D.",
      "scode": "FAM449-FP-A"
    },
    {
      "cname": "Salem",
      "lat": "42.517663",
      "lng": "-70.889082",
      "preceptor": "Chitra Vijayaraghavan, M.D.",
      "scode": "FAM450-FP-A"
    },
    {
      "cname": "Needham",
      "lat": "42.280929",
      "lng": "-71.237755",
      "preceptor": "Kenneth McWha, M.D.",
      "scode": "FAM452-FP-A"
    },
    {
      "cname": "Northampton",
      "lat": "42.312550",
      "lng": "-72.625208",
      "preceptor": "Grace Goncero, M.D.",
      "scode": "FAM453-FP-A"
    },
    {
      "cname": "Merrimack",
      "lat": "42.838019",
      "lng": "-71.491426",
      "preceptor": "Archie Dickinson, M.D.",
      "scode": "FAM456-FP-A"
    },
    {
      "cname": "Westboro",
      "lat": "42.278651",
      "lng": "-71.607931",
      "preceptor": "Veronica Rusu, M.D.",
      "scode": "FAM457-FP-A"
    },
    {
      "cname": "Melrose",
      "lat": "42.458587",
      "lng": "-71.063016",
      "preceptor": "Timothy Tierney, M.D.",
      "scode": "FAM458-FP-A"
    },
    {
      "cname": "Needham",
      "lat": "42.278694",
      "lng": "-71.237559",
      "preceptor": "Gerald Corcoran, M.D.",
      "scode": "FAM461-FP-A"
    },
    {
      "cname": "Pembroke",
      "lat": "42.107958",
      "lng": "-70.773497",
      "preceptor": "Carole Smith, M.D.",
      "scode": "FAM462-FP-A"
    },
    {
      "cname": "Malden",
      "lat": "42.429411",
      "lng": "-71.067752",
      "preceptor": "Patricia Sereno, M.D.",
      "scode": "FAM463-FP-A"
    },
    {
      "cname": "Brockton",
      "lat": "42.057863",
      "lng": "-71.062026",
      "preceptor": "Michael Dern, M.D.",
      "scode": "FAM466-FP-A"
    },
    {
      "cname": "Westminster",
      "lat": "42.545879",
      "lng": "-71.912579",
      "preceptor": "Stephen Weedon, M.D.",
      "scode": "FAM467-FP-A"
    },
    {
      "cname": "Framingham",
      "lat": "42.297113",
      "lng": "-71.425933",
      "preceptor": "Emil Yagudin, M.D.",
      "scode": "FAM469-FP-A"
    },
    {
      "cname": "Wellesley Hills",
      "lat": "42.308430",
      "lng": "-71.278668",
      "preceptor": "Parul I. Desai, M.D. and Leonard Finn, M.D.",
      "scode": "FAM470-FP-A"
    },
    {
      "cname": "Middleton",
      "lat": "42.595094",
      "lng": "-71.016164",
      "preceptor": "Meghan Tramontozzi, M.D.",
      "scode": "FAM471-FP-A"
    },
    {
      "cname": "Arlington",
      "lat": "42.416416",
      "lng": "-71.154299",
      "preceptor": "Bari Brodsky, M.D.",
      "scode": "FAM472-FP-A"
    },
    {
      "cname": "Beverly",
      "lat": "42.585919",
      "lng": "-70.885839",
      "preceptor": "Tina Waugh, M.D.",
      "scode": "FAM474-FP-A"
    },
    {
      "cname": "Orleans",
      "lat": "41.785114",
      "lng": "-69.967659",
      "preceptor": "Timothy Reed, M.D.",
      "scode": "FAM475-FP-A"
    },
    {
      "cname": "Norton",
      "lat": "41.966794",
      "lng": "-71.187496",
      "preceptor": "Mark Zullo, M.D.",
      "scode": "FAM476-FP-A"
    },
    {
      "cname": "North Easton",
      "lat": "42.089653",
      "lng": "-71.094908",
      "preceptor": "Geoffrey Gilson, M.D.",
      "scode": "FAM476-FP-A"
    },
    {
      "cname": "Woburn",
      "lat": "42.496149",
      "lng": "-71.125886",
      "preceptor": "Wynne Huang, M.D.",
      "scode": "FAM479-FP-A"
    },
    {
      "cname": "Malden",
      "lat": "42.422677",
      "lng": "-71.072238",
      "preceptor": "Clinton Pong, M.D.",
      "scode": "FAM481-FP-A"
    },
    {
      "cname": "Lynn",
      "lat": "42.465110",
      "lng": "-70.943708",
      "preceptor": "Landrey Fagan, M.D.",
      "scode": "FAM482-FP-A"
    },
    {
      "cname": "Westford",
      "lat": "42.626148",
      "lng": "-71.419370",
      "preceptor": "Amy Lee, M.D.",
      "scode": "FAM484-FP-A"
    },
    {
      "cname": "Wilmington",
      "lat": "42.859042",
      "lng": "-72.851687",
      "preceptor": "Peter Park, M.D.",
      "scode": "FAM485-FP-A"
    },
    {
      "cname": "Tewksbury",
      "lat": "42.598098",
      "lng": "-71.218202",
      "preceptor": "John Ragucci, M.D.",
      "scode": "FAM490-FP-A"
    },
    {
      "cname": "Shelburne Falls",
      "lat": "42.604251",
      "lng": "-72.739259",
      "preceptor": "Stefan Topolski, M.D.",
      "scode": "FAM491-FP-A"
    },
    {
      "cname": "Somerville",
      "lat": "42.395636",
      "lng": "-71.122337",
      "preceptor": "Deb Bershel, M.D.",
      "scode": "FAM493-FP-A"
    },
    {
      "cname": "Nashua",
      "lat": "42.708259",
      "lng": "-71.467839",
      "preceptor": "J. Terry Buchanan, M.D.",
      "scode": "FAM496-FP-A"
    },
    {
      "cname": "Walpole",
      "lat": "42.137063",
      "lng": "-71.265672",
      "preceptor": "Kay Thompson, M.D.",
      "scode": "FAM497-FP-A"
    },
    {
      "cname": "Northboro",
      "lat": "42.321115",
      "lng": "-71.633271",
      "preceptor": "John Stevenson, M.D.",
      "scode": "FAM498-FP-A"
    },
    {
      "cname": "Naples",
      "lat": "43.990566",
      "lng": "-70.605247",
      "preceptor": "Stephen Barter, M.D.",
      "scode": "FAM505-FP-A"
    },
    {
      "cname": "Kittery, Maine Track Only",
      "lat": "43.088126",
      "lng": "-70.736137",
      "preceptor": "Trevor Braden, M.D.",
      "scode": "FAM506-FP-A"
    },
    {
      "cname": "Portland, Maine Track Only",
      "lat": "43.661471",
      "lng": "-70.255326",
      "preceptor": "Catherine Crute, M.D.",
      "scode": "FAM508-FP-A"
    },
    {
      "cname": "Hiram, Maine Track Only",
      "lat": "43.835063",
      "lng": "-70.832251",
      "preceptor": "Joseph deKay, D.O.",
      "scode": "FAM509-FP-A"
    },
    {
      "cname": "Gouldsboro, Open to All",
      "lat": "44.478520",
      "lng": "-68.039543",
      "preceptor": "Casey Hanson, M.D.",
      "scode": "FAM511-FP-A"
    },
    {
      "cname": "Augusta, Maine Track Only",
      "lat": "44.310624",
      "lng": "-69.779490",
      "preceptor": "Armand Auger, M.D. and Kiran Mangalam, D.O.",
      "scode": "FAM512-FP-A"
    },
    {
      "cname": "Wolfeboro",
      "lat": "43.585207",
      "lng": "-71.209480",
      "preceptor": "Eric Lewis, M.D.",
      "scode": "FAM514-FP-A"
    },
    {
      "cname": "Westbrook, Maine Track Only",
      "lat": "43.677025",
      "lng": "-70.371162",
      "preceptor": "Brett Loffredo, M.D.",
      "scode": "FAM515-FP-A"
    },
    {
      "cname": "Topsham",
      "lat": "43.927543",
      "lng": "-69.975946",
      "preceptor": "David Salko, M.D.",
      "scode": "FAM518-FP-A"
    },
    {
      "cname": "Portland, Maine Track Only",
      "lat": "43.663454",
      "lng": "-70.245016",
      "preceptor": "Kristen Silvia, M.D.",
      "scode": "FAM519-FP-A"
    },
    {
      "cname": "Lewiston, Maine Track Only",
      "lat": "44.100351",
      "lng": "-70.214776",
      "preceptor": "Bethany Picker, M.D.",
      "scode": "FAM520-FP-A"
    },
    {
      "cname": "Portland, Maine Track Only",
      "lat": "43.666993",
      "lng": "-70.254178",
      "preceptor": "Peggy Cyr, M.D.",
      "scode": "FAM524-FP-A"
    },
    {
      "cname": "Millinocket",
      "lat": "45.652908",
      "lng": "-68.715981",
      "preceptor": "Marco Cornelio, M.D.",
      "scode": "FAM529-FP-A"
    }
  ]
};
var cs_latlng = [];
var cs_latlng_1 = [];
var cs_latlng_2 = [];
var cs_latlng_3 = [];

var cs_marker = [];
var cs_contentString = [];
var cs_infowindow = [];
var map = null;
var mapOptions = null;
var dms = null;
var home_marker = null;

function qsort(a) {
    if (a.length == 0) return [];
 
    var left = [], right = [], pivot = a[0];
 
    for (var i = 1; i < a.length; i++) {
        a[i].duration < pivot.duration ? left.push(a[i]) : right.push(a[i]);
    }
    return qsort(left).concat(pivot, qsort(right));
}

function map_recenter(latlng,offsetx,offsety) {
    var point1 = map.getProjection().fromLatLngToPoint(
        (latlng instanceof google.maps.LatLng) ? latlng : map.getCenter()
    );
    var point2 = new google.maps.Point(
        ( (typeof(offsetx) == 'number' ? offsetx : 0) / Math.pow(2, map.getZoom()) ) || 0,
        ( (typeof(offsety) == 'number' ? offsety : 0) / Math.pow(2, map.getZoom()) ) || 0
    );  
    map.setCenter(map.getProjection().fromPointToLatLng(new google.maps.Point(
        point1.x - point2.x,
        point1.y + point2.y
    )));
}

function setEventListener(map, marker, infowindow){
    google.maps.event.addListener(marker, 'click', function() {
    map_recenter(marker.getPosition(),-200, 0);
    for (i = 0; i < cs_infowindow.length; i++){
      cs_infowindow[i].close();
    }
    infowindow.open(map,marker);
    });
}

function initialize() {
    mapOptions = {
      center: { lat: 42.304506, lng: -69.9500},
      zoom: 8
    };
    map = new google.maps.Map(document.getElementById('map-canvas'),
        mapOptions);
    dms = new google.maps.DistanceMatrixService();
    for (i = 0; i < listOfSites.cities.length; i++) { // Create LatLng object for each site
        cs_latlng.push(new google.maps.LatLng(listOfSites.cities[i].lat, 
            listOfSites.cities[i].lng));

        cs_contentString.push("<h3>" + listOfSites.cities[i].cname + "</h3>\n" + 
                              "<p> Preceptor: " + listOfSites.cities[i].preceptor + "<br />" +
                              "Site code: " + listOfSites.cities[i].scode + "</p>");
        cs_infowindow.push(new google.maps.InfoWindow({
            content: cs_contentString[i] }));
        cs_marker.push(new google.maps.Marker({
                        position: cs_latlng[i],
                        map: map,
                        title: listOfSites.cities[i].cname}));
        setEventListener(map, cs_marker[i], cs_infowindow[i]);
    }
    cs_latlng_1 = cs_latlng.slice(0,25);
    cs_latlng_2 = cs_latlng.slice(25,50);
    cs_latlng_3 = cs_latlng.slice(50, cs_latlng.length);

    geocoder = new google.maps.Geocoder();
}
var dmrOptions = null;
var dmr = null;
var responses = null;
var status = null;
var status2 = null;

var order = [];
var tmp = null;
var tableString = null;

var mapclick = false;

var geocoder = null;

function process(e){
    var home = [$('#address').val()];
    geocoder.geocode( { address: home[0]}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        var image = {
          url: 'http://maps.google.com/mapfiles/kml/shapes/homegardenbusiness.png',
          // This marker is 20 pixels wide by 32 pixels tall.
          scaledSize: new google.maps.Size(24, 24),
        };
        if (home_marker !== null) {
          home_marker.setMap(null);
        }
        home_marker = new google.maps.Marker({
            map: map,
            position: results[0].geometry.location,
            icon: image
        });
      } else {
        console.log('Geocode was not successful for the following reason: ' + status);
        return;
      }
    });
    dmrOptions = {
      destinations: cs_latlng_1,
      origins: home,
      travelMode: google.maps.TravelMode.DRIVING,
      unitSystem: google.maps.UnitSystem.IMPERIAL
    };
    dms.getDistanceMatrix(dmrOptions, function(DistanceMatrixResponse, DistanceMatrixStatus){ 
      responses = DistanceMatrixResponse.rows[0].elements;
      status = DistanceMatrixStatus;
      dmrOptions = {
        destinations: cs_latlng_2,
        origins: home,
        travelMode: google.maps.TravelMode.DRIVING,
        unitSystem: google.maps.UnitSystem.IMPERIAL
      };
      dms.getDistanceMatrix(dmrOptions, function(DistanceMatrixResponse, DistanceMatrixStatus){ 
      responses = responses.concat(DistanceMatrixResponse.rows[0].elements);
      status2 = DistanceMatrixStatus;
      dmrOptions = {
        destinations: cs_latlng_3,
        origins: home,
        travelMode: google.maps.TravelMode.DRIVING,
        unitSystem: google.maps.UnitSystem.IMPERIAL
      };
      dms.getDistanceMatrix(dmrOptions, function(DistanceMatrixResponse, DistanceMatrixStatus){
        responses = responses.concat(DistanceMatrixResponse.rows[0].elements);
        status = DistanceMatrixStatus;
        order = [];
        for (j = 0; j < cs_latlng.length; j++){
          tmp = {
            city: listOfSites.cities[j].cname,
            scode: listOfSites.cities[j].scode,
            distance_text: responses[j].distance.text,
            distance: responses[j].distance.value,
            duration_text: responses[j].duration.text,
            duration: responses[j].duration.value
          };
          order.push(tmp);
        }
        order = qsort(order);
        tableString = '';
        // Create Table String
        tableString = '<table id="myTable" class="table table-striped"><thead><tr><th>Site</th><th>Code</th><th>Duration</th><th>Distance</th></tr></thead><tbody>';
        for(k = 0; k < order.length; k++){
          tableString = tableString + '<tr class="myRow" scode=' + order[k].scode + '><td>' + order[k].city + '</td><td>' + order[k].scode + '</td><td>' + order[k].duration_text + '</td><td>' + order[k].distance_text + '</td></tr>';
        }
        tableString = tableString + '</tbody></table>';
        // Insert new element
        $('#myTable').remove()
        $('#table-area').append(tableString);
      });
    });
  });
}

$(document).ready(function(){
  $('#find').on('click', function (e) {
    e.preventDefault();
    process(e);
  });
  $('form input').keydown(function(e){
    if(e.keyCode == 13) {
      e.preventDefault();
      process(e);
    }
  });
  /*
  $('#excludeMonday').change(function(){
    if ($('#excludeMonday').prop('checked') && $('#excludeTuesday').prop('checked')){
      for (i = 0; i < cs_marker.length; i++){
        cs_marker[i].setVisible(false);
      }
    } else if ($('#excludeMonday').prop('checked')){
      for (i = 0; i < cs_marker.length; i++){
        if (listOfSites.cities[i].tuesday == "0"){
          cs_marker[i].setVisible(false);
        }
      }
    } else if (!$('#excludeMonday').prop('checked') && $('#excludeTuesday').prop('checked')){
      for (i = 0; i < cs_marker.length; i++){
        cs_marker[i].setVisible(true);
        if (listOfSites.cities[i].monday == "0"){
          cs_marker[i].setVisible(false);
        }
      }
    } else {
      for (i = 0; i < cs_marker.length; i++){
        cs_marker[i].setVisible(true);
      }
    }
  });
  $('#excludeTuesday').change(function(){
    if ($('#excludeTuesday').prop('checked') && $('#excludeMonday').prop('checked')){
      for (i = 0; i < cs_marker.length; i++){
        cs_marker[i].setVisible(false);
      }
    } else if ($('#excludeTuesday').prop('checked')){
      for (i = 0; i < cs_marker.length; i++){
        if (listOfSites.cities[i].monday == "0"){
          cs_marker[i].setVisible(false);
        }
      }
    } else if (!$('#excludeTuesday').prop('checked') && $('#excludeMonday').prop('checked')){
      for (i = 0; i < cs_marker.length; i++){
        cs_marker[i].setVisible(true);
        if (listOfSites.cities[i].tuesday == "0"){
          cs_marker[i].setVisible(false);
        }
      }
    } else {
      for (i = 0; i < cs_marker.length; i++){
        cs_marker[i].setVisible(true);
      }
    }
  });
*/
  $(document).on("mouseenter", ".myRow", function() {
    mapclick = false;
    var scode = "";
    for(i = 0; i < listOfSites.cities.length; i++){
      if (listOfSites.cities[i].scode.split(" ").length > 1){
        scode = listOfSites.cities[i].scode.substr(0, listOfSites.cities[i].scode.indexOf(" "));
      } else {
        scode = listOfSites.cities[i].scode
      }
      if (scode != $(this).attr('scode')){
        cs_marker[i].setVisible(false);
      }
    }
  });
  $(document).on("mouseleave", ".myRow", function() {
    if(!mapclick){
      for(i = 0; i < listOfSites.cities.length; i++){
        if ($('#excludeMonday').prop('checked') && $('#excludeTuesday').prop('checked')){
          for (i = 0; i < cs_marker.length; i++){
            cs_marker[i].setVisible(false);
          }
        } else if (!$('#excludeMonday').prop('checked') && $('#excludeTuesday').prop('checked')) {
          if (listOfSites.cities[i].monday != "0"){
            cs_marker[i].setVisible(true);
          }
        } else if (!$('#excludeTuesday').prop('checked') && $('#excludeMonday').prop('checked')) {
          if (listOfSites.cities[i].tuesday != "0"){
            cs_marker[i].setVisible(true);
          }
        } else {
          cs_marker[i].setVisible(true);
        }
      }
    }
  });
  $(document).on("click", ".myRow", function() {
    mapclick = true;
    for(i = 0; i < listOfSites.cities.length; i++){
      if (listOfSites.cities[i].scode.split(" ").length > 1){
        scode = listOfSites.cities[i].scode.substr(0, listOfSites.cities[i].scode.indexOf(" "));
      } else {
        scode = listOfSites.cities[i].scode
      }
      if (scode != $(this).attr('scode')){
        cs_marker[i].setVisible(false);
      }
    }
  });
});

google.maps.event.addDomListener(window, 'load', initialize);
